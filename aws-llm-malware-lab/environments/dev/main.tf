###############################################################################
# Dev Environment – Root Module Composition
###############################################################################

module "network" {
  source = "../../modules/network"

  environment         = var.environment
  aws_region          = var.aws_region
  vpc_cidr            = var.vpc_cidr
  public_subnet_cidr  = var.public_subnet_cidr
  private_subnet_cidr = var.private_subnet_cidr
  availability_zone   = var.availability_zone
  blocked_cidrs       = var.blocked_cidrs
}

module "storage" {
  source = "../../modules/storage"

  environment    = var.environment
  aws_region     = var.aws_region
  vpc_id         = module.network.vpc_id
  vpce_s3_id     = module.network.vpce_s3_id
  kms_admin_arns = var.kms_admin_arns

  route_table_ids = [
    module.network.private_route_table_id,
    module.network.public_route_table_id,
  ]
}

module "security" {
  source = "../../modules/security"

  environment            = var.environment
  aws_region             = var.aws_region
  vpc_id                 = module.network.vpc_id
  private_subnet_id      = module.network.private_subnet_id
  analyst_principal_arns = var.analyst_principal_arns
  s3_bucket_arn          = module.storage.bucket_arn
  kms_key_arn            = module.storage.kms_key_arn
}

module "compute" {
  source = "../../modules/compute"

  environment       = var.environment
  aws_region        = var.aws_region
  private_subnet_id = module.network.private_subnet_id
  gpu_instance_type = var.gpu_instance_type
  spot_max_price    = var.spot_max_price
  asg_desired       = var.asg_desired
  asg_min           = var.asg_min
  asg_max           = var.asg_max

  detonation_sg_id        = module.network.detonation_sg_id
  instance_profile_name   = module.security.instance_profile_name
  s3_bucket_name          = module.storage.bucket_name
}

# ─── Re-declare root variables so this composition file can reference them ────

variable "aws_region"            { type = string }
variable "environment"           { type = string }
variable "vpc_cidr"              { type = string }
variable "public_subnet_cidr"    { type = string }
variable "private_subnet_cidr"   { type = string }
variable "availability_zone"     { type = string }
variable "gpu_instance_type"     { type = string }
variable "spot_max_price"        { type = string }
variable "asg_desired"           { type = number }
variable "asg_min"               { type = number }
variable "asg_max"               { type = number }
variable "blocked_cidrs"         { type = list(string) }
variable "analyst_principal_arns" { type = list(string) }
variable "kms_admin_arns"        { type = list(string) }

# ─── Outputs ─────────────────────────────────────────────────────────────────

output "vpc_id" {
  value = module.network.vpc_id
}

output "detonation_bucket" {
  value = module.storage.bucket_name
}

output "asg_name" {
  value = module.compute.asg_name
}
