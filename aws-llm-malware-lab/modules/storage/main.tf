###############################################################################
# Storage Module – S3 Bucket, KMS CMK, VPC-Only Policy, GuardDuty, EventBridge
###############################################################################

data "aws_caller_identity" "current" {}

locals {
  name_prefix = "malware-lab-${var.environment}"
  account_id  = data.aws_caller_identity.current.account_id
}

# ─── KMS Customer Managed Key (SSE-KMS) ─────────────────────────────────────

resource "aws_kms_key" "s3" {
  description             = "CMK for LLM malware lab S3 bucket encryption"
  deletion_window_in_days = 14
  enable_key_rotation     = true

  policy = jsonencode({
    Version = "2012-10-17"
    Id      = "malware-lab-s3-cmk"
    Statement = concat(
      [
        {
          Sid       = "EnableRootAccount"
          Effect    = "Allow"
          Principal = { AWS = "arn:aws:iam::${local.account_id}:root" }
          Action    = "kms:*"
          Resource  = "*"
        }
      ],
      length(var.kms_admin_arns) > 0 ? [
        {
          Sid       = "AllowKeyAdmins"
          Effect    = "Allow"
          Principal = { AWS = var.kms_admin_arns }
          Action = [
            "kms:Create*",
            "kms:Describe*",
            "kms:Enable*",
            "kms:List*",
            "kms:Put*",
            "kms:Update*",
            "kms:Revoke*",
            "kms:Disable*",
            "kms:Get*",
            "kms:Delete*",
            "kms:ScheduleKeyDeletion",
            "kms:CancelKeyDeletion",
          ]
          Resource = "*"
        }
      ] : [],
      [
        {
          Sid       = "AllowS3ServiceUsage"
          Effect    = "Allow"
          Principal = { Service = "s3.amazonaws.com" }
          Action = [
            "kms:Decrypt",
            "kms:GenerateDataKey",
          ]
          Resource = "*"
        }
      ],
    )
  })

  tags = { Name = "${local.name_prefix}-s3-cmk" }
}

resource "aws_kms_alias" "s3" {
  name          = "alias/${local.name_prefix}-s3"
  target_key_id = aws_kms_key.s3.key_id
}

# ─── S3 Bucket ───────────────────────────────────────────────────────────────

resource "aws_s3_bucket" "models" {
  bucket_prefix = "${local.name_prefix}-models-"
  force_destroy = false

  tags = {
    Name        = "${local.name_prefix}-models"
    Environment = "MalwareLab"
  }
}

# Block all public access
resource "aws_s3_bucket_public_access_block" "models" {
  bucket = aws_s3_bucket.models.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# Disable legacy ACLs – BucketOwnerEnforced
resource "aws_s3_bucket_ownership_controls" "models" {
  bucket = aws_s3_bucket.models.id

  rule {
    object_ownership = "BucketOwnerEnforced"
  }
}

# SSE-KMS default encryption
resource "aws_s3_bucket_server_side_encryption_configuration" "models" {
  bucket = aws_s3_bucket.models.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.s3.arn
    }
    bucket_key_enabled = true
  }
}

# Versioning (aids forensic analysis)
resource "aws_s3_bucket_versioning" "models" {
  bucket = aws_s3_bucket.models.id
  versioning_configuration {
    status = "Enabled"
  }
}

# ─── Bucket Policy: Deny Unless from VPC Endpoint ───────────────────────────

resource "aws_s3_bucket_policy" "vpce_only" {
  bucket = aws_s3_bucket.models.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "DenyGetPutUnlessVPCE"
        Effect    = "Deny"
        Principal = "*"
        Action = [
          "s3:GetObject",
          "s3:PutObject",
        ]
        Resource = "${aws_s3_bucket.models.arn}/*"
        Condition = {
          StringNotEquals = {
            "aws:sourceVpce" = var.vpce_s3_id
          }
        }
      },
    ]
  })
}

# ─── EventBridge: Notify on PutObject (for GuardDuty / custom scanning) ─────

resource "aws_s3_bucket_notification" "eventbridge" {
  bucket      = aws_s3_bucket.models.id
  eventbridge = true
}

resource "aws_cloudwatch_event_rule" "s3_put" {
  name_prefix = "${local.name_prefix}-model-upload-"
  description = "Fires on every PutObject to the model-ingestion bucket"

  event_pattern = jsonencode({
    source      = ["aws.s3"]
    detail-type = ["Object Created"]
    detail = {
      bucket = {
        name = [aws_s3_bucket.models.id]
      }
    }
  })

  tags = { Name = "${local.name_prefix}-s3-put-rule" }
}

# Target: CloudWatch log group as a sink (swap for Lambda / Step Functions
# when GuardDuty Malware Protection for S3 is wired in).
resource "aws_cloudwatch_log_group" "s3_events" {
  name              = "/malware-lab/${var.environment}/s3-events"
  retention_in_days = 30
  tags              = { Name = "${local.name_prefix}-s3-events-log" }
}

resource "aws_cloudwatch_event_target" "s3_put_log" {
  rule = aws_cloudwatch_event_rule.s3_put.name
  arn  = aws_cloudwatch_log_group.s3_events.arn
}

# Allow EventBridge to write to the log group
data "aws_iam_policy_document" "eventbridge_logs" {
  statement {
    actions   = ["logs:CreateLogStream", "logs:PutLogEvents"]
    resources = ["${aws_cloudwatch_log_group.s3_events.arn}:*"]

    principals {
      type        = "Service"
      identifiers = ["events.amazonaws.com"]
    }
  }
}

resource "aws_cloudwatch_log_resource_policy" "eventbridge" {
  policy_name     = "${local.name_prefix}-eb-s3-events"
  policy_document = data.aws_iam_policy_document.eventbridge_logs.json
}

# ─── GuardDuty Malware Protection for S3 ────────────────────────────────────
# NOTE: GuardDuty must already be enabled in the account.  The detector data
# source below activates the S3 malware scanning feature.  If GuardDuty is
# managed outside this stack, import or comment out the detector resource.

resource "aws_guardduty_detector" "lab" {
  enable = true

  datasources {
    malware_protection {
      scan_ec2_instance_with_findings {
        ebs_volumes {
          enable = true
        }
      }
    }
    s3_logs {
      enable = true
    }
  }

  tags = { Name = "${local.name_prefix}-guardduty" }
}
