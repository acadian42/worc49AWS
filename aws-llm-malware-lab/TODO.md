# TODO — AWS LLM Malware Testing Laboratory

## Pre-Deployment (Must Do Before Apply)

- [ ] Create S3 state bucket (`llm-malware-lab-tfstate`) and DynamoDB lock table (`llm-malware-lab-tflock`)
- [ ] Populate `analyst_principal_arns` in `terraform.tfvars` with real IAM user/role ARNs
- [ ] Populate `kms_admin_arns` in `terraform.tfvars` with key administrator ARNs
- [ ] Add known-malicious CIDRs to `blocked_cidrs` (threat intel feeds, blocklists)
- [ ] Verify AWS credentials are configured (SSO, env vars, or instance profile)
- [ ] Confirm GPU Spot capacity availability in the target region/AZ (`g4dn.xlarge`, `g5.xlarge`)
- [ ] Check that GuardDuty is not already enabled in the account (avoid detector conflict)

## Network Hardening

- [ ] Add VPC endpoints for SSM, SSMMessages, and EC2Messages to avoid routing SSM traffic through the NAT instance
- [ ] Evaluate adding a VPC endpoint for CloudWatch Logs to keep log traffic off the public internet
- [ ] Add a VPC endpoint for KMS to keep decryption calls private
- [ ] Consider adding a VPC endpoint for Bedrock (`bedrock-runtime`) if evaluation calls originate from the VPC
- [ ] Review and expand the Route 53 DNS Firewall allowlist as operational needs evolve
- [ ] Add CloudWatch alarms on NAT instance CPU/network to detect saturation or compromise
- [ ] Add an Elastic Network Interface (ENI) health check for the NAT instance with automatic failover

## Storage Improvements

- [ ] Add S3 lifecycle rules to transition old model weights to Glacier or expire after N days
- [ ] Add S3 Inventory configuration for auditing bucket contents
- [ ] Wire the EventBridge rule to a Lambda function for custom scan logic (e.g., YARA rules on model files)
- [ ] Configure SNS topic for GuardDuty finding notifications
- [ ] Add S3 access logging to a separate audit bucket
- [ ] Evaluate S3 Object Lock (compliance mode) for forensic evidence preservation

## Security Enhancements

- [ ] Add CloudTrail trail scoped to the lab account/region for API-level auditing
- [ ] Create an AWS Config rule to detect security group drift (unexpected port opens)
- [ ] Add a CloudWatch alarm on IAM permission boundary detachment attempts
- [ ] Implement SCPs at the OU level if the lab runs in a dedicated AWS account (recommended)
- [ ] Add MFA enforcement for analysts assuming roles into the lab environment
- [ ] Rotate the NAT instance AMI periodically for patching (or automate with SSM Patch Manager)
- [ ] Review SSM Session Manager idle timeout (currently 30 min) against operational needs
- [ ] Consider AWS Secrets Manager for any runtime secrets the detonation hosts may need

## Compute Improvements

- [ ] Add a Spot interruption handler (EventBridge rule -> Lambda) to snapshot EBS before termination
- [ ] Create a custom AMI with NVIDIA drivers + Ollama pre-baked to speed up boot time
- [ ] Add CloudWatch agent to detonation hosts for GPU utilization and memory metrics
- [ ] Parameterize the EBS root volume size (currently hardcoded at 100 GiB)
- [ ] Add instance store (NVMe) mount logic for `g5.xlarge` ephemeral storage
- [ ] Consider adding a warm pool to the ASG for faster scaling
- [ ] Add ASG scaling policies based on SQS queue depth or custom metrics (models awaiting detonation)

## Operational Tooling

- [ ] Build a `Makefile` or `Taskfile` wrapping common Terraform + AWS CLI operations
- [ ] Add `terraform fmt` and `terraform validate` to a CI pre-commit hook
- [ ] Integrate `tfsec` or `checkov` static analysis into the CI pipeline
- [ ] Add `terratest` Go tests for validating module outputs and connectivity
- [ ] Create a `scripts/` directory with helper scripts:
  - [ ] `upload-model.sh` — upload model weights to S3 via the CLI
  - [ ] `connect.sh` — wrapper around `aws ssm start-session` with instance discovery
  - [ ] `teardown.sh` — safe destroy with confirmation prompts
- [ ] Add cost estimation with `infracost` in CI

## Multi-Environment

- [ ] Create `environments/staging/` and `environments/prod/` configurations
- [ ] Parameterize the S3 backend key per environment to avoid state collisions
- [ ] Add a `locals.tf` per environment for environment-specific overrides
- [ ] Consider Terraform workspaces or Terragrunt for DRY multi-env management

## Documentation

- [ ] Add architecture diagram to the README
- [ ] Document the model detonation playbook (upload -> scan -> detonate -> evaluate -> report)
- [ ] Document incident response procedures if a detonation escapes containment
- [ ] Add a CONTRIBUTING.md if the lab will be maintained by a team
- [ ] Document the DNS Firewall allowlist update procedure
- [ ] Add runbooks for common operational tasks (scaling up, adding analysts, rotating keys)
